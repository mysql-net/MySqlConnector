parameters:
  image: ''
  connectionString: ''
  testPath: '$(Build.BinariesDirectory)/10.0'

steps:
- task: DeleteFiles@1
  condition: always()
  inputs:
    contents: '**/*.trx'
- task: DownloadPipelineArtifact@2
  condition: always()
  inputs:
    buildType: 'current'
    artifactName: 'Conformance.Tests-10.0-$(Agent.OS)'
    targetPath: ${{ parameters.testPath }}
- bash: chmod +x ${{ parameters.testPath }}/Conformance.Tests
  displayName: 'Set execute permissions for xUnit v3'
  condition: ne(variables['Agent.OS'], 'Windows_NT')
- task: DotNetCoreCLI@2
  displayName: 'Conformance Tests'
  inputs:
    command: 'custom'
    custom: 'vstest'
    arguments: '${{ parameters.testPath }}/Conformance.Tests.dll /logger:trx'
  env:
    CONNECTION_STRING: ${{ parameters.connectionString }}
- task: PublishTestResults@2
  condition: always()
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '**/*.trx'
    testRunTitle: ${{ format('Conformance Tests, {0}, $(Agent.OS)', parameters.image) }}
    failTaskOnFailedTests: true
